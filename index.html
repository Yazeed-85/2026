<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ 2026</title>
    <meta name="theme-color" content="#0f172a">
    <style>
        /* --- Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† (Themes) --- */
        :root {
            --bg-main: #0f172a; 
            --bg-card: rgba(30, 41, 59, 0.7); 
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --accent: #38bdf8; 
            --today-glow: 0 0 15px rgba(56, 189, 248, 0.5);
            --border-color: rgba(255,255,255,0.1);
            --modal-bg: #1e293b;
            --table-border: rgba(255,255,255,0.2);
            --header-cell-bg: rgba(56, 189, 248, 0.2);
        }

        [data-theme="energy"] {
            --bg-main: #2e1065; 
            --bg-card: rgba(88, 28, 135, 0.5);
            --text-main: #fff;
            --text-sub: #cbd5e1;
            --accent: #fb923c; 
            --today-glow: 0 0 20px rgba(251, 146, 60, 0.6);
            --border-color: rgba(255,255,255,0.15);
            --modal-bg: #4c1d95;
            --table-border: rgba(255,255,255,0.3);
            --header-cell-bg: rgba(251, 146, 60, 0.25);
        }

        [data-theme="zen"] {
            --bg-main: #14532d; 
            --bg-card: rgba(22, 101, 52, 0.6);
            --text-main: #ecfdf5;
            --text-sub: #a7f3d0;
            --accent: #86efac; 
            --today-glow: 0 0 15px rgba(134, 239, 172, 0.5);
            --border-color: rgba(255,255,255,0.1);
            --modal-bg: #166534;
            --table-border: rgba(255,255,255,0.2);
            --header-cell-bg: rgba(134, 239, 172, 0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: background 0.4s, box-shadow 0.4s; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-main); color: var(--text-main); 
            margin: 0; padding: 0; padding-bottom: 80px; 
            min-height: 100vh; overflow-x: hidden;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        header {
            padding: 20px 20px 10px 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        
        .weather-widget { display: flex; flex-direction: column; gap: 5px; }
        .city-name { font-size: 0.9rem; font-weight: bold; color: var(--text-sub); display: flex; align-items: center; gap: 5px; }
        .temp-status { font-size: 1.5rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .weather-desc { font-size: 0.8rem; opacity: 0.8; }

        .time-widget { text-align: left; }
        .live-time { font-size: 1.8rem; font-weight: 800; color: var(--accent); font-variant-numeric: tabular-nums; }
        .live-date { font-size: 0.85rem; color: var(--text-sub); }

        .controls-bar { display: flex; justify-content: space-between; padding: 10px 20px; align-items: center; margin-top: 10px;}
        .theme-btn { 
            background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); 
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: bold;
            backdrop-filter: blur(10px);
        }
        
        /* --- Ø§Ù„ØªÙ‚ÙˆÙŠÙ… --- */
        .calendar-container { padding: 0 15px; margin-top: 15px; }
        
        /* ØªÙˆØ³ÙŠØ· Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ø£Ø´Ù‡Ø± */
        .month-nav {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
            background: var(--bg-card); padding: 10px; border-radius: 15px; backdrop-filter: blur(10px); border: 1px solid var(--border-color);
        }
        .nav-btn { background: none; border: none; color: var(--accent); font-size: 1.5rem; cursor: pointer; font-weight: bold; width: 50px; text-align: center; }
        .month-title { font-size: 1.3rem; font-weight: bold; text-align: center; flex: 1; }

        .weekdays {
            display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 10px;
        }

        /* Ù†Ø¹ÙˆÙ…Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø´Ù‡Ø± */
        .days-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .days-grid.fade {
            opacity: 0; transform: scale(0.97);
        }

        .day-cell {
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px;
            aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: space-between;
            padding: 5px; cursor: pointer; position: relative; backdrop-filter: blur(5px);
        }
        .day-cell:active { transform: scale(0.95); }
        .day-cell.empty { background: none; border: none; cursor: default; backdrop-filter: none; }
        
        .day-num-greg { font-size: 1.1rem; font-weight: 800; line-height: 1; text-align: right;}
        .day-num-hijri { font-size: 0.65rem; color: var(--text-sub); text-align: left; }
        
        .color-indicator { position: absolute; top: 6px; left: 6px; width: 8px; height: 8px; border-radius: 50%; display: none; }
        .has-tasks { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--text-main); border-radius: 50%; display: none; }

        @keyframes breathe {
            0% { box-shadow: 0 0 5px var(--accent); }
            50% { box-shadow: var(--today-glow); border-color: var(--accent); }
            100% { box-shadow: 0 0 5px var(--accent); }
        }
        .day-cell.today {
            border: 2px solid var(--accent); background: rgba(0,0,0,0.3);
            animation: breathe 3s infinite ease-in-out;
        }

        /* --- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙŠÙˆÙ… --- */
        .fab-today {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--accent); color: var(--bg-main); border: none;
            padding: 10px 25px; border-radius: 30px; font-weight: bold; font-size: 0.95rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 1000;
            opacity: 0; pointer-events: none;
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.6s ease;
        }
        .fab-today.visible {
            transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto;
        }

        /* --- Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0); z-index: 5000; align-items: flex-end;
            transition: background 0.4s ease;
        }
        .modal-overlay.active { display: flex; }
        .modal-overlay.show { background: rgba(0,0,0,0.7); }
        
        .bottom-sheet {
            background: var(--modal-bg); width: 100%; border-radius: 25px 25px 0 0;
            padding: 20px 20px 40px 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
            max-height: 85vh; overflow-y: auto; border-top: 1px solid var(--border-color);
            transform: translateY(100%); 
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }
        .modal-overlay.show .bottom-sheet { transform: translateY(0); }

        .sheet-handle { width: 40px; height: 5px; background: var(--text-sub); border-radius: 5px; margin: 0 auto 15px auto; }
        
        .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;}
        .modal-title { font-size: 1.3rem; font-weight: bold; margin: 0; color: var(--accent);}
        .modal-subtitle { font-size: 0.9rem; color: var(--text-sub); margin-top: 5px;}
        
        .color-picker { display: flex; gap: 15px; margin-bottom: 20px; justify-content: center;}
        .color-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s;}
        .color-circle.selected { transform: scale(1.2); border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.5);}

        .section-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; color: var(--text-main); border-right: 3px solid var(--accent); padding-right: 8px;}
        .todo-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .todo-input { flex: 1; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; padding: 12px; border-radius: 10px; font-size: 1rem; }
        .add-todo-btn { background: var(--accent); color: #000; border: none; border-radius: 10px; padding: 0 20px; font-weight: bold; cursor: pointer;}
        
        .todo-list { list-style: none; padding: 0; margin: 0; margin-bottom: 25px;}
        .todo-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.1); padding: 12px 15px; border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border-color); }
        .todo-item.done span { text-decoration: line-height; opacity: 0.5; }
        .todo-check { width: 20px; height: 20px; accent-color: var(--accent); }
        .del-todo { color: #ef4444; background: none; border: none; cursor: pointer; font-size: 1.1rem; }

        .notes-area { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; padding: 15px; border-radius: 12px; font-size: 1rem; min-height: 100px; resize: none; font-family: inherit; margin-bottom: 20px;}

        /* --- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠØ© (Smart Tables) --- */
        .table-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 10px;}
        .table-input { width: 60px; padding: 8px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; border-radius: 5px; text-align: center;}
        .table-btn { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9rem;}
        .table-btn:active { background: var(--accent); color: #000;}
        .table-wrapper { overflow-x: auto; margin-bottom: 10px; border-radius: 8px; }
        
        table.custom-table { width: 100%; border-collapse: collapse; text-align: center; }
        table.custom-table td { min-width: 60px; padding: 10px; background: rgba(0,0,0,0.2); outline: none; transition: all 0.2s; }
        
        /* Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Headers) Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ */
        table.custom-table td.is-header {
            background-color: var(--header-cell-bg);
            color: var(--accent);
            font-weight: bold;
            border: 1px solid var(--accent) !important; /* Ø¥Ø·Ø§Ø± Ù…Ù…ÙŠØ² */
        }

        table.custom-table.bordered td { border: 1px solid var(--table-border); }
        table.custom-table.no-border td { border: 1px dashed rgba(255,255,255,0.05); }
        
        .table-actions { display: flex; gap: 8px; margin-bottom: 25px; justify-content: flex-end;}
        .icon-action-btn { 
            background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); border-radius: 8px; 
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; 
            font-size: 1.1rem; cursor: pointer; color: var(--text-main); transition: transform 0.2s;
        }
        .icon-action-btn:active { transform: scale(0.9); }
        .icon-action-btn.danger { color: #ef4444; border-color: rgba(239,68,68,0.3); }
        
        .edit-tools { display: none; gap: 8px; margin-bottom: 10px; justify-content: center; }
        .edit-btn-small { background: var(--bg-card); border: 1px solid var(--accent); color: var(--accent); padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;}

        .save-btn { width: 100%; background: var(--accent); color: #000; padding: 15px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

    </style>
</head>
<body>

    <header>
        <div class="weather-widget">
            <div class="city-name" id="cityName">ğŸ“ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</div>
            <div class="temp-status">
                <span id="weatherEmoji">â³</span>
                <span id="weatherTemp">--Â°</span>
            </div>
            <div class="weather-desc" id="weatherDesc">...</div>
        </div>
        <div class="time-widget">
            <div class="live-time" id="liveTime">00:00</div>
            <div class="live-date" id="liveDate">...</div>
        </div>
    </header>

    <div class="controls-bar">
        <button class="theme-btn" onclick="cycleTheme()">ğŸ¨ Ø§Ù„Ù…Ø¸Ù‡Ø±</button>
        <button class="theme-btn" style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; border-color: #ef4444;" onclick="exportData()">ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
    </div>

    <div class="calendar-container">
        <div class="month-nav">
            <button class="nav-btn" onclick="triggerMonthChange(-1)">â®</button>
            <div class="month-title" id="monthYearDisplay">ÙŠÙ†Ø§ÙŠØ± 2026</div>
            <button class="nav-btn" onclick="triggerMonthChange(1)">â¯</button>
        </div>

        <div class="weekdays">
            <div>Ø§Ù„Ø£Ø­Ø¯</div><div>Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</div><div>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</div><div>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</div><div>Ø§Ù„Ø®Ù…ÙŠØ³</div><div>Ø§Ù„Ø¬Ù…Ø¹Ø©</div><div>Ø§Ù„Ø³Ø¨Øª</div>
        </div>
        <div class="days-grid" id="calendarGrid"></div>
    </div>

    <button class="fab-today" id="fabToday" onclick="triggerGoToToday()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙŠÙˆÙ…</button>

    <div class="modal-overlay" id="dayModal" onclick="closeModal(event)">
        <div class="bottom-sheet" id="bottomSheet">
            <div class="sheet-handle"></div>
            
            <div class="modal-header">
                <div>
                    <h3 class="modal-title" id="modalGregDate">15 ÙŠÙˆÙ†ÙŠÙˆ 2026</h3>
                    <div class="modal-subtitle" id="modalHijriDate">1 Ù…Ø­Ø±Ù… 1448</div>
                </div>
                <button style="background:none;border:none;color:var(--text-sub);font-size:1.5rem;cursor:pointer;" onclick="closeModal(true)">âœ•</button>
            </div>

            <div class="color-picker">
                <div class="color-circle" data-color="#ef4444" style="background: #ef4444;" onclick="selectColor('#ef4444')"></div>
                <div class="color-circle" data-color="#f59e0b" style="background: #f59e0b;" onclick="selectColor('#f59e0b')"></div>
                <div class="color-circle" data-color="#10b981" style="background: #10b981;" onclick="selectColor('#10b981')"></div>
                <div class="color-circle" data-color="#3b82f6" style="background: #3b82f6;" onclick="selectColor('#3b82f6')"></div>
                <div class="color-circle" data-color="#8b5cf6" style="background: #8b5cf6;" onclick="selectColor('#8b5cf6')"></div>
                <div class="color-circle" data-color="" style="background: transparent; border-color: var(--text-sub);" onclick="selectColor('')" title="Ø¨Ø¯ÙˆÙ† Ù„ÙˆÙ†">âœ–</div>
            </div>

            <div class="section-title">ğŸ“‹ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="todo-input-group">
                <input type="text" id="todoInput" class="todo-input" placeholder="Ø§ÙƒØªØ¨ Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©...">
                <button class="add-todo-btn" onclick="addTodo()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <ul class="todo-list" id="todoList"></ul>

            <div class="section-title" style="display: flex; justify-content: space-between;">
                <span>ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</span>
                <span style="font-size: 0.7rem; font-weight: normal; color: var(--text-sub);">Ø§Ù†Ù‚Ø± Ù…Ø±ØªÙŠÙ† Ù„Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </div>
            
            <div class="table-controls" id="tableSetup">
                <label style="font-size:0.9rem">ØµÙÙˆÙ:</label> <input type="number" id="tRows" class="table-input" value="3" min="1" max="10">
                <label style="font-size:0.9rem">Ø£Ø¹Ù…Ø¯Ø©:</label> <input type="number" id="tCols" class="table-input" value="2" min="1" max="5">
                <label style="font-size:0.9rem"><input type="checkbox" id="tBorder" checked> Ø­Ø¯ÙˆØ¯</label>
                <button class="table-btn" onclick="createTable()">Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„</button>
            </div>
            
            <div class="edit-tools" id="editTools">
                <button class="edit-btn-small" onclick="addRow()">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
                <button class="edit-btn-small" onclick="addCol()">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯</button>
            </div>

            <div class="table-wrapper" id="tableContainer"></div>
            
            <div class="table-actions" id="tableActions" style="display: none;">
                <button class="icon-action-btn" title="ØªØ¹Ø¯ÙŠÙ„ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„" onclick="toggleEditMode()">âœï¸</button>
                <button class="icon-action-btn" title="Ù†Ø³Ø® Ø§Ù„Ø¬Ø¯ÙˆÙ„" onclick="copyTable()">ğŸ“„</button>
                <button class="icon-action-btn" id="pasteBtn" title="Ù„ØµÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„" onclick="pasteTable()" style="display: none;">ğŸ“‹</button>
                <button class="icon-action-btn danger" title="Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹" onclick="deleteTable()">ğŸ—‘ï¸</button>
            </div>
            <button class="table-btn" id="quickPasteBtn" onclick="pasteTable()" style="display: none; margin-bottom: 25px; width: 100%;">ğŸ“‹ Ù„ØµÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø³ÙˆØ® Ù‡Ù†Ø§</button>

            <div class="section-title">ğŸ“ Ù…Ø°ÙƒØ±Ø§Øª ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª</div>
            <textarea id="notesInput" class="notes-area" placeholder="Ø§ÙƒØªØ¨ Ù…Ø°ÙƒØ±Ø§ØªÙƒ Ø£Ùˆ Ø£ÙÙƒØ§Ø±Ùƒ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù‡Ù†Ø§..."></textarea>

            <button class="save-btn" onclick="saveDayData()">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©</button>
        </div>
    </div>

    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        let currentDisplayedDate = new Date();
        const today = new Date();
        let db = JSON.parse(localStorage.getItem('cal2026_db')) || {};
        let activeDayKey = null; 
        let activeColor = '';
        let currentTableData = null;

        const monthNames = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];

        // Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹
        const themes = ['night', 'energy', 'zen'];
        let currentThemeIndex = parseInt(localStorage.getItem('cal2026_theme')) || 0;
        function applyTheme() {
            document.documentElement.setAttribute('data-theme', themes[currentThemeIndex]);
            localStorage.setItem('cal2026_theme', currentThemeIndex);
        }
        function cycleTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            applyTheme();
        }
        applyTheme();

        // Ø§Ù„ÙˆÙ‚Øª
        function updateTime() {
            const now = new Date();
            document.getElementById('liveTime').innerText = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('liveDate').innerText = now.toLocaleDateString('ar-SA', { weekday: 'long', day: 'numeric', month: 'short' });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // --- Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø·Ù‚Ø³ (Ø¬Ù„Ø¨ Ø¹Ø¨Ø± Ø§Ù„Ù€ IP Ù„ØªØ®Ø·ÙŠ Ø­Ø¸Ø± Ø§Ù„Ù…ØªØµÙØ­Ø§Øª) ---
        async function initWeather() {
            const fallbackTabuk = () => {
                document.getElementById('cityName').innerText = `ğŸ“ ØªØ¨ÙˆÙƒ`;
                fetchWeatherAPI(28.3833, 36.5833);
            };

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© IP Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯ÙˆÙ† Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª (ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹)
                const ipRes = await fetch('https://ipapi.co/json/');
                const ipData = await ipRes.json();
                
                if(ipData && ipData.latitude) {
                    const city = ipData.city || "Ù…ÙˆÙ‚Ø¹Ùƒ";
                    document.getElementById('cityName').innerText = `ğŸ“ ${city}`;
                    fetchWeatherAPI(ipData.latitude, ipData.longitude);
                } else {
                    fallbackTabuk();
                }
            } catch(e) {
                // ÙÙŠ Ø­Ø§Ù„ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù†Øª ØªÙ…Ø§Ù…Ø§
                fallbackTabuk();
            }
        }

        async function fetchWeatherAPI(lat, lon) {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                const data = await res.json();
                const weather = data.current_weather;
                
                document.getElementById('weatherTemp').innerText = `${Math.round(weather.temperature)}Â°`;
                
                const wCode = weather.weathercode;
                let emoji = 'ğŸŒ¤ï¸', desc = 'ØµØ§ÙÙŠ';
                if (wCode === 0) { emoji = 'â˜€ï¸'; desc = 'Ø³Ù…Ø§Ø¡ ØµØ§ÙÙŠØ©'; }
                else if (wCode >= 1 && wCode <= 3) { emoji = 'â›…'; desc = 'ØºØ§Ø¦Ù… Ø¬Ø²Ø¦ÙŠØ§Ù‹'; }
                else if (wCode >= 45 && wCode <= 48) { emoji = 'ğŸŒ«ï¸'; desc = 'Ø¶Ø¨Ø§Ø¨'; }
                else if (wCode >= 51 && wCode <= 67) { emoji = 'ğŸŒ§ï¸'; desc = 'Ø£Ù…Ø·Ø§Ø±'; }
                else if (wCode >= 71 && wCode <= 77) { emoji = 'â„ï¸'; desc = 'Ø«Ù„ÙˆØ¬'; }
                else if (wCode >= 80 && wCode <= 82) { emoji = 'â›ˆï¸'; desc = 'Ø£Ù…Ø·Ø§Ø± ØºØ²ÙŠØ±Ø©'; }
                else if (wCode >= 95) { emoji = 'ğŸŒ©ï¸'; desc = 'Ø¹ÙˆØ§ØµÙ Ø±Ø¹Ø¯ÙŠØ©'; }
                
                document.getElementById('weatherEmoji').innerText = emoji;
                document.getElementById('weatherDesc').innerText = desc;
            } catch (error) {
                document.getElementById('weatherDesc').innerText = "Ø§Ù„Ø·Ù‚Ø³ ØºÙŠØ± Ù…ØªØ§Ø­";
            }
        }
        initWeather();

        // --- ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… ---
        function triggerMonthChange(offset) {
            const grid = document.getElementById('calendarGrid');
            grid.classList.add('fade');
            setTimeout(() => {
                currentDisplayedDate.setMonth(currentDisplayedDate.getMonth() + offset);
                renderCalendar();
                grid.classList.remove('fade');
            }, 300); // 300ms transition
        }

        function triggerGoToToday() {
            const grid = document.getElementById('calendarGrid');
            grid.classList.add('fade');
            setTimeout(() => {
                currentDisplayedDate = new Date(today.getFullYear(), today.getMonth(), 1);
                renderCalendar();
                grid.classList.remove('fade');
            }, 300);
        }

        const getDateKey = (y, m, d) => `${y}-${m+1}-${d}`;

        function getHijriFormat(date) {
            const formatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {day: 'numeric', month: 'long', year:'numeric'});
            return formatter.format(date);
        }

        function renderCalendar() {
            const year = currentDisplayedDate.getFullYear();
            const month = currentDisplayedDate.getMonth();
            
            document.getElementById('monthYearDisplay').innerText = `${monthNames[month]} ${year}`;
            
            const fab = document.getElementById('fabToday');
            if(year === today.getFullYear() && month === today.getMonth()) {
                fab.classList.remove('visible');
            } else {
                fab.classList.add('visible');
            }
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell empty';
                grid.appendChild(emptyCell);
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const cellDate = new Date(year, month, d);
                const dateKey = getDateKey(year, month, d);
                const dayData = db[dateKey] || {};

                const cell = document.createElement('div');
                cell.className = 'day-cell';
                
                if (d === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    cell.classList.add('today');
                }

                if (dayData.color) {
                    const colorDot = document.createElement('div');
                    colorDot.className = 'color-indicator';
                    colorDot.style.display = 'block';
                    colorDot.style.backgroundColor = dayData.color;
                    cell.appendChild(colorDot);
                    cell.style.backgroundColor = `${dayData.color}22`; 
                    cell.style.borderColor = `${dayData.color}55`;
                }

                if ((dayData.todos && dayData.todos.length > 0) || dayData.table) {
                    const taskDot = document.createElement('div');
                    taskDot.className = 'has-tasks';
                    taskDot.style.display = 'block';
                    cell.appendChild(taskDot);
                }

                const gregSpan = document.createElement('span');
                gregSpan.className = 'day-num-greg';
                gregSpan.innerText = d;
                
                const hijriStr = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {day: 'numeric'}).format(cellDate);
                const hijriSpan = document.createElement('span');
                hijriSpan.className = 'day-num-hijri';
                hijriSpan.innerText = hijriStr;

                cell.appendChild(gregSpan);
                cell.appendChild(hijriSpan);

                cell.onclick = () => openDayModal(cellDate, dateKey);

                grid.appendChild(cell);
            }
        }

        // --- Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† ---
        function openDayModal(dateObj, dateKey) {
            activeDayKey = dateKey;
            const dayData = db[dateKey] || { todos: [], notes: '', color: '', table: null };
            
            const dayName = dateObj.toLocaleDateString('ar-SA', { weekday: 'long' });
            document.getElementById('modalGregDate').innerText = `${dayName}ØŒ ${dateObj.getDate()} ${monthNames[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
            document.getElementById('modalHijriDate').innerText = getHijriFormat(dateObj);

            document.getElementById('notesInput').value = dayData.notes || '';

            activeColor = dayData.color || '';
            updateColorSelection();
            renderTodos();
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
            currentTableData = dayData.table ? JSON.parse(JSON.stringify(dayData.table)) : null;
            document.getElementById('editTools').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            checkClipboard(); 
            renderTableUI();

            const modal = document.getElementById('dayModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; 
            
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    modal.classList.add('show');
                });
            });
        }

        function closeModal(e) {
            if (e === true || e.target.id === 'dayModal') {
                saveTableData(); 
                const modal = document.getElementById('dayModal');
                
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }, 500); 
            }
        }

        function selectColor(colorHex) {
            activeColor = colorHex;
            updateColorSelection();
        }

        function updateColorSelection() {
            const circles = document.querySelectorAll('.color-circle');
            circles.forEach(c => {
                c.classList.remove('selected');
                if (c.dataset.color === activeColor) {
                    c.classList.add('selected');
                }
            });
        }

        // --- Ø§Ù„Ù…Ù‡Ø§Ù… ---
        function renderTodos() {
            const list = document.getElementById('todoList');
            list.innerHTML = '';
            const dayData = db[activeDayKey] || { todos: [] };
            
            if(!dayData.todos) dayData.todos = [];

            dayData.todos.forEach((todo, index) => {
                const li = document.createElement('li');
                li.className = `todo-item ${todo.done ? 'done' : ''}`;
                
                const check = document.createElement('input');
                check.type = 'checkbox';
                check.className = 'todo-check';
                check.checked = todo.done;
                check.onchange = () => toggleTodo(index);

                const textSpan = document.createElement('span');
                textSpan.style.flex = "1";
                textSpan.style.marginRight = "10px";
                textSpan.innerText = todo.text;

                const delBtn = document.createElement('button');
                delBtn.className = 'del-todo';
                delBtn.innerHTML = 'âœ•';
                delBtn.onclick = () => deleteTodo(index);

                li.appendChild(check);
                li.appendChild(textSpan);
                li.appendChild(delBtn);
                list.appendChild(li);
            });
        }

        function addTodo() {
            const input = document.getElementById('todoInput');
            const text = input.value.trim();
            if (!text) return;

            if (!db[activeDayKey]) db[activeDayKey] = { todos: [], notes: '', color: '', table: null };
            if (!db[activeDayKey].todos) db[activeDayKey].todos = [];

            db[activeDayKey].todos.push({ text: text, done: false });
            input.value = '';
            renderTodos();
            saveToDb(); 
        }

        function toggleTodo(index) {
            db[activeDayKey].todos[index].done = !db[activeDayKey].todos[index].done;
            renderTodos();
            saveToDb();
        }

        function deleteTodo(index) {
            db[activeDayKey].todos.splice(index, 1);
            renderTodos();
            saveToDb();
        }

        // --- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© ---
        function renderTableUI() {
            const container = document.getElementById('tableContainer');
            const setup = document.getElementById('tableSetup');
            const actions = document.getElementById('tableActions');
            const quickPaste = document.getElementById('quickPasteBtn');
            
            container.innerHTML = '';

            if (currentTableData) {
                setup.style.display = 'none';
                quickPaste.style.display = 'none';
                actions.style.display = 'flex';

                // ØªØ±Ù‚ÙŠØ© Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ù†ØµÙŠØ© Ø¥Ù„Ù‰ Ø£ÙˆØ¨Ø¬ÙƒØª)
                currentTableData.data = currentTableData.data.map(row => 
                    row.map(cell => typeof cell === 'string' ? { text: cell, isHeader: false } : cell)
                );

                const table = document.createElement('table');
                table.className = `custom-table ${currentTableData.border ? 'bordered' : 'no-border'}`;
                
                currentTableData.data.forEach((rowData, rIndex) => {
                    const tr = document.createElement('tr');
                    rowData.forEach((cellData, cIndex) => {
                        const td = document.createElement('td');
                        td.contentEditable = "true";
                        td.innerText = cellData.text;
                        
                        if(cellData.isHeader) td.classList.add('is-header');

                        // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                        td.oninput = function() {
                            currentTableData.data[rIndex][cIndex].text = this.innerText;
                        };
                        
                        // Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ù„ÙŠØ© ÙƒØ±Ø¦ÙŠØ³ÙŠØ©
                        td.ondblclick = function() {
                            const isH = currentTableData.data[rIndex][cIndex].isHeader;
                            currentTableData.data[rIndex][cIndex].isHeader = !isH;
                            if(!isH) this.classList.add('is-header');
                            else this.classList.remove('is-header');
                        };

                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                });
                container.appendChild(table);
            } else {
                setup.style.display = 'flex';
                actions.style.display = 'none';
                document.getElementById('editTools').style.display = 'none';
                checkClipboard(); 
            }
        }

        function createTable() {
            const rows = parseInt(document.getElementById('tRows').value) || 3;
            const cols = parseInt(document.getElementById('tCols').value) || 2;
            const border = document.getElementById('tBorder').checked;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ù„Ø§ÙŠØ§ Ø°ÙƒÙŠØ©
            const emptyData = Array.from({length: rows}, () => 
                Array.from({length: cols}, () => ({text: "", isHeader: false}))
            );
            currentTableData = { rows, cols, border, data: emptyData };
            
            renderTableUI();
        }

        // Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø¬Ø¯ÙˆÙ„
        function deleteTable() {
            if(confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ…Ø§Ù…Ø§Ù‹ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                currentTableData = null;
                if (db[activeDayKey]) {
                    db[activeDayKey].table = null; 
                }
                saveToDb();
                renderTableUI();
                renderCalendar(); 
            }
        }

        // Ø¥Ø¯Ø±Ø§Ø¬ ØµÙ ÙˆØ¹Ù…ÙˆØ¯
        function toggleEditMode() {
            const tools = document.getElementById('editTools');
            tools.style.display = tools.style.display === 'flex' ? 'none' : 'flex';
        }
        function addRow() {
            if(!currentTableData) return;
            const newRow = Array.from({length: currentTableData.cols}, () => ({text: "", isHeader: false}));
            currentTableData.data.push(newRow);
            currentTableData.rows++;
            renderTableUI();
        }
        function addCol() {
            if(!currentTableData) return;
            currentTableData.data.forEach(row => {
                row.push({text: "", isHeader: false});
            });
            currentTableData.cols++;
            renderTableUI();
        }

        function saveTableData() {
            if (currentTableData) {
                if (!db[activeDayKey]) db[activeDayKey] = { todos: [], notes: '', color: '' };
                db[activeDayKey].table = currentTableData;
            }
        }

        function copyTable() {
            if(currentTableData) {
                localStorage.setItem('cal2026_clipboard_table', JSON.stringify(currentTableData));
                checkClipboard();
                // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ù†Ø³Ø®
                const btn = document.querySelector('button[title="Ù†Ø³Ø® Ø§Ù„Ø¬Ø¯ÙˆÙ„"]');
                btn.style.background = 'var(--accent)';
                btn.style.color = '#000';
                setTimeout(() => { btn.style.background=''; btn.style.color=''; }, 500);
            }
        }

        function checkClipboard() {
            const clip = localStorage.getItem('cal2026_clipboard_table');
            const pasteBtn = document.getElementById('pasteBtn');
            const quickPasteBtn = document.getElementById('quickPasteBtn');
            
            if(clip) {
                if(currentTableData) {
                    pasteBtn.style.display = 'flex';
                    quickPasteBtn.style.display = 'none';
                } else {
                    pasteBtn.style.display = 'none';
                    quickPasteBtn.style.display = 'block';
                }
            } else {
                pasteBtn.style.display = 'none';
                quickPasteBtn.style.display = 'none';
            }
        }

        function pasteTable() {
            const clip = localStorage.getItem('cal2026_clipboard_table');
            if(clip) {
                if(currentTableData && !confirm("Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø³ÙˆØ®ØŸ")) return;
                currentTableData = JSON.parse(clip);
                renderTableUI();
            }
        }

        // Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¹Ø§Ù…
        function saveDayData() {
            if (!db[activeDayKey]) db[activeDayKey] = { todos: [] };
            db[activeDayKey].notes = document.getElementById('notesInput').value;
            db[activeDayKey].color = activeColor;
            saveTableData(); 
            
            saveToDb();
            closeModal(true);
            renderCalendar(); 
        }

        function saveToDb() {
            localStorage.setItem('cal2026_db', JSON.stringify(db));
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href",     dataStr);
            downloadAnchorNode.setAttribute("download", "calendar_2026_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        renderCalendar();

    </script>
</body>
</html>